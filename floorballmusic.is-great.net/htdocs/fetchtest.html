<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add music for floorball</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
  h1 { color: #333; }
  .input-container { margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
  .input-field { padding: 8px; font-size: 14px; flex: 1; }
  button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px; }
  button:hover { background-color: #45a049; }
  #output { margin-top: 20px; background-color: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
  #output table { width: 100%; border-collapse: collapse; }
  #output th, #output td { padding: 10px; text-align: left; border: 1px solid #ddd; }
  #output th { background-color: #f2f2f2; }
  .file-select-container { margin-top: 20px; }
  select { padding: 10px; font-size: 14px; margin-top: 10px; }
</style>
</head>
<body>

<h1>Spotify Track Info Fetcher</h1>
<p>Logga in på Spotify och hämta artist och titel baserat på en Spotify URI.</p>

<div id="login-container">
  <button id="login-button">Logga in på Spotify</button>
</div>
<div id="status" style="margin-top: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #fff; min-height: 20px;"></div>

<div class="input-container">
  <input type="text" id="uri-input" class="input-field" placeholder="Spotify URI">
  <input type="text" id="start-time-input" class="input-field" placeholder="Starttid (ms)">
  <button onclick="getCurrentPlayingTrack()">Hämta nuvarande låt</button>
  <button onclick="playTrack()">Play</button>
  <button onclick="stopTrack()">Stoppa</button>
  <button onclick="saveTrackToList()">Spara i lista</button>
</div>

<div id="output">
  <h3>Resultat:</h3>
  <table id="track-table">
    <thead>
      <tr>
        <th>URI</th>
        <th>Titel</th>
        <th>Artist</th>
        <th>Starttid (ms)</th>
        <th>Spela</th>
        <th>Stoppa</th>
        <th>Ta bort</th>
        <th>Finns i filer</th>
      </tr>
    </thead>
    <tbody>
      <!-- Tracks will be dynamically inserted here -->
    </tbody>
  </table>
</div>

<div class="file-select-container">
  <h3>Välj fil att spara till:</h3>
  <select id="file-select">
    <option value="Warmup.json">Warmup.json</option>
    <option value="Intro.json">Intro.json</option>
    <option value="Goal.json">Goal.json</option>
    <option value="Heavy.json">Heavy.json</option>
    <option value="Spelpauser.json">Spelpauser.json</option>
    <option value="Spelpauser2.json">Spelpauser2.json</option>
    <option value="Utvisning.json">Utvisning.json</option>
    <option value="GameEvents.json">GameEvents.json</option>
    <option value="After.json">After.json</option>
    <option value="Publik.json">Publik.json</option>
    <option value="Periodpaus.json">Periodpaus.json</option>
    <option value="Pregame.json">Pregame.json</option>
  </select>
  <button onclick="saveTracksToFile()">Spara till fil</button>
</div>

<script src="spotify_auth.js"></script>
<script>
let trackList = [];
let currentlyPlayingTrack = null;

// Dynamic redirect URI
const redirectUri = window.location.href.split('?')[0];

// Initialize auth on page load
window.onload = async () => {
  await handleRedirect(redirectUri);

  if (accessToken) {
    document.getElementById("status").textContent = "Inloggad på Spotify!";
  } else {
    document.getElementById("status").textContent = "Logga in för att använda Spotify-funktioner.";
  }
};

// login button click
document.getElementById("login-button").onclick = () =>
  loginToSpotify(redirectUri);


// --- Fetch current playing track ---
async function getCurrentPlayingTrack() {
  if (!accessToken) return document.getElementById("status").textContent = "Du måste logga in på Spotify först.";
  try {
    const res = await fetch("https://api.spotify.com/v1/me/player/currently-playing", { headers: { "Authorization": `Bearer ${ensureAccessToken()}` } });
    if (!res.ok) throw new Error(res.status);
    const data = await res.json();
    if (!data?.item) return document.getElementById("status").textContent = "Ingen låt spelas för tillfället.";

    const uri = data.item.uri;
    const progressMs = data.progress_ms;
    const trackTitle = data.item.name;
    const trackArtist = data.item.artists.map(a => a.name).join(", ");

    document.getElementById("uri-input").value = uri;
    document.getElementById("start-time-input").value = progressMs;

    const filesContainingTrack = await checkTrackInFiles(uri);
    const fileNames = filesContainingTrack.length > 0 ? filesContainingTrack.join(", ") : "Inga";

    document.getElementById("status").textContent = `Nuvarande låt: ${trackTitle} av ${trackArtist}. Finns i filer: ${fileNames}`;
  } catch (err) {
    console.error(err);
    document.getElementById("status").textContent = "Kunde inte hämta nuvarande låt.";
  }
}

// --- Check JSON files ---
async function checkTrackInFiles(uri) {
  const fileNames = ["Warmup.json","Intro.json","Goal.json","Spelpauser.json","Spelpauser2.json","Utvisning.json","GameEvents.json","After.json","Publik.json","Pregame.json","Periodpaus.json"];
  const containingFiles = [];
  for (const f of fileNames) {
    try {
      const res = await fetch(`/tracks/${f}`);
      if (!res.ok) continue;
      const data = await res.json();
      if (data.tracks?.some(t => t.spotifyURI === uri)) containingFiles.push(f);
    } catch(e) { console.warn(e); }
  }
  return containingFiles;
}

// --- Table management ---
function updateTrackTable() {
  const tbody = document.querySelector("#track-table tbody");
  tbody.innerHTML = "";
  trackList.forEach((track, idx) => {
    const row = tbody.insertRow();
    row.insertCell(0).textContent = track.spotifyURI;
    row.insertCell(1).textContent = track.title;
    row.insertCell(2).textContent = track.artist;
    row.insertCell(3).textContent = track.starttime;

    const playBtn = document.createElement("button");
    playBtn.textContent = "Play";
    playBtn.onclick = () => playSpotifyTrack(track.spotifyURI, track.starttime);
    row.insertCell(4).appendChild(playBtn);

    const stopBtn = document.createElement("button");
    stopBtn.textContent = "Stoppa";
    stopBtn.onclick = stopTrack;
    row.insertCell(5).appendChild(stopBtn);

    const delBtn = document.createElement("button");
    delBtn.textContent = "X";
    delBtn.onclick = () => { trackList.splice(idx,1); updateTrackTable(); };
    row.insertCell(6).appendChild(delBtn);
  });
}

// --- Save track to list ---
async function saveTrackToList() {
  const uri = document.getElementById("uri-input").value.trim();
  const startTime = parseInt(document.getElementById("start-time-input").value.trim());
  if (!uri) return document.getElementById("status").textContent = "Ange en giltig Spotify URI.";
  if (!accessToken) return document.getElementById("status").textContent = "Du måste logga in på Spotify först.";

  try {
    const trackId = uri.split(":")[2];
    const res = await fetch(`https://api.spotify.com/v1/tracks/${trackId}`, { headers: { "Authorization": `Bearer ${ensureAccessToken()}` } });
    if (!res.ok) throw new Error(res.status);
    const data = await res.json();
    trackList.push({ spotifyURI: uri, starttime: isNaN(startTime)?0:startTime, artist: data.artists[0]?.name || "Okänd artist", title: data.name || "Okänd titel" });
    updateTrackTable();
    document.getElementById("status").textContent = "Låt tillagd i listan.";
    document.getElementById("uri-input").value = "";
    document.getElementById("start-time-input").value = "";
  } catch (err) {
    console.error(err);
    document.getElementById("status").textContent = "Kunde inte hämta låtinfo.";
  }
}

// --- Play / Stop ---
function playSpotifyTrack(uri, startTime) {
  fetch("https://api.spotify.com/v1/me/player/play", {
    method: "PUT",
    headers: { "Authorization": `Bearer ${ensureAccessToken()}`, "Content-Type": "application/json" },
    body: JSON.stringify({ uris:[uri], position_ms:startTime })
  }).catch(err=>alert("Kunde inte spela upp låten."));
}

function stopTrack() {
  fetch("https://api.spotify.com/v1/me/player/pause", { method:"PUT", headers:{ "Authorization": `Bearer ${ensureAccessToken()}` } })
    .then(()=>document.getElementById("status").textContent="Uppspelningen stoppad")
    .catch(err=>document.getElementById("status").textContent="Kunde inte stoppa uppspelningen");
}

function playTrack() {
  const uri = document.getElementById("uri-input").value.trim();
  const startTime = parseInt(document.getElementById("start-time-input").value.trim());
  if (!uri) return document.getElementById("status").textContent = "Ange en giltig Spotify URI.";
  if (!accessToken) return document.getElementById("status").textContent = "Du måste logga in på Spotify först.";
  playSpotifyTrack(uri, isNaN(startTime)?0:startTime);
  document.getElementById("status").textContent="Låten spelas upp.";
}

// --- Save list to file ---
function saveTracksToFile() {
  const fileName = document.getElementById("file-select").value;
  if (!fileName || trackList.length===0) return document.getElementById("status").textContent="Välj en fil och lägg till låtar först.";

  fetch('save_to_file.php',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ filename:fileName, tracks:trackList })
  }).then(res=>res.json())
    .then(data=>{
      if(data.success){ trackList=[]; updateTrackTable(); document.getElementById("status").textContent="Låtarna har sparats till filen. Resultattabellen har rensats."; }
      else document.getElementById("status").textContent="Fel vid sparande av låtar.";
    }).catch(err=>document.getElementById("status").textContent="Kunde inte spara låtarna till fil.");
}
</script>
</body>
</html>
